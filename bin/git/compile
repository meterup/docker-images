#!/usr/bin/env bash

set -euo pipefail

cleanup() {
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*
}

main() {
    local -r VERSION="$1"
    local -r BINARY="v${VERSION}.zip"
    local -r DIRECTORY="git-${VERSION}"

    pushd /tmp 2>/dev/null
        if [[ ! -f "$BINARY" ]]; then
            curl --remote-name --silent --show-error --location "https://github.com/git/git/archive/${BINARY}"
        fi
        unzip -q "$BINARY"
        pushd "${DIRECTORY}" 2>/dev/null
            # https://git-scm.com/book/en/v2/Getting-Started-Installing-Git
            make configure
            ./configure --prefix=/usr/local/git --without-expat --without-tcltk
            make -j4 all
            make install
        popd
        rm -rf "${BINARY}" "${DIRECTORY}"
        cleanup
        /usr/local/git/bin/git --version
    popd
}

main "$@"
